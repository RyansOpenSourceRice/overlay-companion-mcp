:80 {
  encode gzip

  # Custom Overlay Web Interface (main interface with MCP-powered icons)
  @overlay path_regexp overlay ^/($|index\.html|app|overlay|static|assets)
  handle @overlay {
    reverse_proxy overlay-web:8080
  }

  # MCP Server API endpoints (split overlay MCP and control MCP)
  @mcp_api path_regexp mcp_api ^/(api|mcp|health)
  handle @mcp_api {
    reverse_proxy mcp-server:3000
  }

  # Control MCP (input/window/process control)
  handle_path /control-mcp* {
    reverse_proxy control-mcp:3003
  }

  # MCP WebSocket connections
  handle_path /ws/* {
    reverse_proxy mcp-server:3000
  }

  # KasmVNC web client
  handle_path /vnc/* {
    reverse_proxy kasmvnc:6901
  }

  # KasmVNC admin/API (optional)
  handle_path /vnc-api/* {
    reverse_proxy kasmvnc:3000
  }

  # Default: route to custom overlay web interface
  handle {
    reverse_proxy overlay-web:8080
  }
}
